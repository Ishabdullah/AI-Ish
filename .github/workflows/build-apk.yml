name: Build AI-Ish APK (Production)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build Production APK (S24 Ultra Optimized)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ðŸ”§ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ðŸ“¦ Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --no-daemon

      - name: ðŸš€ Build Release APK (Production)
        run: ./gradlew assembleRelease --stacktrace --no-daemon

      - name: ðŸ“Š Get APK Info
        id: apk_info
        run: |
          DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          DEBUG_SIZE=$(du -h "$DEBUG_APK" | cut -f1)
          RELEASE_SIZE=$(du -h "$RELEASE_APK" | cut -f1)
          
          echo "debug_size=$DEBUG_SIZE" >> $GITHUB_OUTPUT
          echo "release_size=$RELEASE_SIZE" >> $GITHUB_OUTPUT
          
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Debug APK: $DEBUG_SIZE"
          echo "ðŸš€ Release APK: $RELEASE_SIZE"

      - name: ðŸ“¤ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: ai-ish-debug-${{ steps.apk_info.outputs.commit_short }}
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: ðŸ“¤ Upload Release APK (Production)
        uses: actions/upload-artifact@v4
        with:
          name: ai-ish-production-${{ steps.apk_info.outputs.commit_short }}
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APK Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | Size | Optimization |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Debug** | ${{ steps.apk_info.outputs.debug_size }} | Development build |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release** | ${{ steps.apk_info.outputs.release_size }} | ðŸš€ S24 Ultra NPU optimized |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Production Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NPU (Hexagon v81): Mistral-7B prefill + MobileNet-v3" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CPU (Cores 0-3): Mistral-7B decode + BGE embeddings" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… INT8 quantization across all models" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Concurrent execution: All 3 models in parallel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Performance Targets (S24 Ultra)" >> $GITHUB_STEP_SUMMARY
          echo "- LLM: 25-35 tokens/sec (NPU + CPU)" >> $GITHUB_STEP_SUMMARY
          echo "- Vision: ~60 FPS (NPU)" >> $GITHUB_STEP_SUMMARY
          echo "- Embeddings: ~500 emb/s (CPU)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download APKs" >> $GITHUB_STEP_SUMMARY
          echo "Go to the **Artifacts** section above to download the APKs." >> $GITHUB_STEP_SUMMARY

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Release APK
        uses: actions/download-artifact@v4

      - name: ðŸŽ‰ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./**/*.apk
          generate_release_notes: true
          body: |
            ## AI-Ish Production Release
            
            **Optimized for Samsung Galaxy S24 Ultra**
            
            ### ðŸš€ Production Features
            - NPU (Hexagon v81): Mistral-7B prefill + MobileNet-v3 vision
            - CPU (Cores 0-3): Mistral-7B decode + BGE embeddings
            - INT8 quantization for maximum performance
            - Concurrent execution: All 3 models run in parallel
            
            ### ðŸ“Š Performance (S24 Ultra)
            - LLM: 25-35 tokens/sec
            - Vision: ~60 FPS
            - Embeddings: ~500 emb/s
            - Memory: ~4.5GB total
            
            ### ðŸ“¥ Installation
            1. Download app-release-unsigned.apk
            2. Install on Samsung S24 Ultra
            3. Grant required permissions
            4. Download production models from in-app dashboard
            
            ### ðŸ”’ Privacy
            - 100% on-device processing
            - Zero telemetry
            - No internet required (except optional knowledge fetching)
            
            **Copyright Â© 2025 Ismail Abdullah. All rights reserved.**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
